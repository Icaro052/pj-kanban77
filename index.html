<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Kanban PCM - Heineken</title>

    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Sortable/1.15.0/Sortable.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/dompurify/3.0.6/purify.min.js"></script>

    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">

    <!-- Verifica sessão local antes de carregar a UI -->
    <script>
        (function(){
            // se não estiver autenticado, redireciona para /login.html
            const user = localStorage.getItem('kanban_user');
            if (!user) {
                // mantém histórico limpo e redireciona
                location.replace('/login.html');
            }
        })();
    </script>

    <!-- NOVO: SDKs do Firebase -->
    <!-- Adicionamos os scripts do Firebase como módulos -->
    <script type="module">
        // Implementação independente usando IndexedDB (API compatível com o que o index.html espera)
        (function(){
            const DB_NAME = 'kanban_local_db_v1';
            const STORE_NAME = 'kanban_kv'; // armazena entradas no formato key = collectionPath::docId
            let dbInstance = null;
            const listeners = {}; // { collectionPath: [cb, ...] }
            const memory = {}; // { collectionPath: { docId: docData, ... }, ... }

            function openIndexedDB() {…}

            function memoryClear() {…}

            function persistEntry(collectionPath, docId, value) {…}

            function removeEntry(collectionPath, docId) {…}

            function notifyListeners(collectionPath) {…}

            function makeSnapshot(collectionPath) {…}

            // API compatível
            const standalone = {…};

            // expõe a API no window para o script principal usar
            window.firebaseSDK = standalone;

            // abre DB imediato para carregar memória e permitir inspeção via console
            openIndexedDB().catch(e => console.warn('IndexedDB init failed', e));
        })();
    </script>

    <style>
        body { font-family: 'Inter', sans-serif; background-color: #f3f4f6; }
        .sortable-ghost { opacity: 0.3; background: #dbeafe; border: 2px dashed #60a5fa; }
        .sortable-chosen { cursor: grabbing; opacity: 0.9; transform: scale(1.02); box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05); }
        .kanban-column-body { max-height: 75vh; overflow-y: auto; }
        .kanban-column-body::-webkit-scrollbar { width: 8px; }
        .kanban-column-body::-webkit-scrollbar-track { background: #f1f1f1; border-radius: 10px; }
        .kanban-column-body::-webkit-scrollbar-thumb { background: #bbf7d0; border-radius: 10px; }
        .kanban-column-body::-webkit-scrollbar-thumb:hover { background: #86efac; }
        input[type=number] { appearance: textfield; -moz-appearance: textfield; }
        input[type=number]::-webkit-inner-spin-button,
        input[type=number]::-webkit-outer-spin-button { -webkit-appearance: none; margin: 0; }
    </style>
</head>
<body class="antialiased text-gray-900">

    <!-- Cabeçalho (Tema Heineken PCM) -->
    <header class="bg-green-800 text-white shadow-lg sticky top-0 z-40">
        <!-- ... (Conteúdo do cabeçalho não modificado) ... -->
        <div class="container mx-auto max-w-full px-4 md:px-8 py-4 flex justify-between items-center">
            <div class="flex items-center space-x-3">
            </div>
            <div class="flex items-center space-x-3">
                <button id="filter-priority-btn" class="relative hidden md:flex items-center space-x-2 bg-green-700 hover:bg-green-600 px-4 py-2 rounded-lg transition-colors duration-200 focus:outline-none focus:ring-2 focus:ring-green-400 focus:ring-offset-2 focus:ring-offset-green-800">
                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-5 h-5 text-gray-300">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M3 7.5 7.5 3m0 0L12 7.5M7.5 3v13.5m13.5 0L16.5 21m0 0L12 16.5m4.5 4.5V7.5" />
                    </svg>
                    <span class="text-sm font-medium">Prioridade</span>
                </button>
                <button id="filter-owner-btn" title="Filtro de Responsável (Em breve)" class="hidden md:flex items-center space-x-2 bg-green-700 hover:bg-green-600 px-4 py-2 rounded-lg transition-colors duration-200 opacity-70 cursor-not-allowed">
                     <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-5 h-5 text-gray-300">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M15.75 6a3.75 3.75 0 1 1-7.5 0 3.75 3.75 0 0 1 7.5 0ZM4.501 20.118a7.5 7.5 0 0 1 14.998 0A1.5 1.5 0 0 1 18 21.75H6a1.5 1.5 0 0 1-1.499-1.632Z" />
                    </svg>
                    <span class="text-sm font-medium">Responsável</span>
                </button>
                <button id="add-task-btn" class="bg-green-600 hover:bg-green-700 px-5 py-2 rounded-lg font-semibold shadow-md transition-all duration-200 focus:outline-none focus:ring-2 focus:ring-green-400 focus:ring-offset-2 focus:ring-offset-green-800">
                    Adicionar OS
                </button>

                <!-- Botão de Autenticação / Usuário -->
                <button id="auth-btn" class="ml-3 bg-white text-green-700 hover:bg-gray-50 px-3 py-2 rounded-lg border border-green-600 text-sm font-medium">
                    Entrar
                </button>
            </div>
        </div>
    </header>
    
    <!-- Indicador de Status de Login e Banco de Dados -->
    <div id="auth-status" class="py-2 px-6 bg-green-900 text-green-200 text-sm text-center sticky top-[80px] z-30">
        Conectando ao banco de dados...
    </div>

    <!-- ...remaining HTML unchanged (modals, board, etc.) ... -->

    <!-- ...existing code... -->

    <script type="module">
        // Aguarda o DOM estar pronto e o SDK do Firebase estar carregado
        document.addEventListener('DOMContentLoaded', () => {
            
            // --- Variáveis Globais do App ---
            
            // Colunas
            const columns = {…};
            const columnIds = Object.keys(columns);

            // Botões e Modais
            const addTaskBtn = document.getElementById('add-task-btn');
            const taskModal = document.getElementById('task-modal');
            const taskModalContent = document.getElementById('task-modal-content');
            const taskForm = document.getElementById('task-form');
            const modalTitle = document.getElementById('modal-title');
            const closeModalBtn = document.getElementById('close-modal-btn');
            const cancelModalBtn = document.getElementById('cancel-modal-btn');
            const saveTaskBtn = document.getElementById('save-task-btn');
            const taskIdInput = document.getElementById('task-id-input');
            const taskIdDisplay = document.getElementById('task-id-display');
            const taskTextInput = document.getElementById('task-text-input');
            const taskPriorityInput = document.getElementById('task-priority-input');
            const taskIdHidden = document.getElementById('task-id-hidden');
            const modalErrorMessage = document.getElementById('modal-error-message');
            const deleteModal = document.getElementById('delete-modal');
            const deleteModalContent = document.getElementById('delete-modal-content');
            
            // --- Autenticação local (integração com a UI existente) ---
            const authBtn = document.getElementById('auth-btn');
            const authStatus = document.getElementById('auth-status');

            function getSession() { return localStorage.getItem('kanban_user'); }
            function clearSession() { localStorage.removeItem('kanban_user'); }

            function updateAuthUI() {
                const user = getSession();
                if (user) {
                    authStatus.textContent = `Conectado como ${user}.`;
                    authBtn.textContent = `Sair (${user.split('@')[0]})`;
                } else {
                    authStatus.textContent = 'Não autenticado.';
                    authBtn.textContent = 'Entrar';
                }
            }

            authBtn.addEventListener('click', (e) => {
                const user = getSession();
                if (user) {
                    // logout
                    clearSession();
                    updateAuthUI();
                    // redireciona para login
                    location.href = '/login.html';
                } else {
                    location.href = '/login.html';
                }
            });

            updateAuthUI();

            main();
        });
    </script>
</body>
</html>