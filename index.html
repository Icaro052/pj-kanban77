<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Kanban PCM - Heineken</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Sortable/1.15.0/Sortable.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/dompurify/3.0.6/purify.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; background-color: #f3f4f6; }
        .sortable-ghost { opacity: 0.3; background: #dbeafe; border: 2px dashed #60a5fa; }
        .sortable-chosen { cursor: grabbing; opacity: 0.9; transform: scale(1.02); box-shadow: 0 10px 15px -3px rgba(0,0,0,0.1); }
        .kanban-column-body { max-height: 75vh; overflow-y: auto; }
    </style>
</head>
<body class="antialiased text-gray-900">

<header class="bg-green-800 text-white shadow-lg sticky top-0 z-40">
    <div class="container mx-auto max-w-full px-4 md:px-8 py-4 flex justify-between items-center">
        <div class="flex items-center space-x-3">
            <svg xmlns="http://www.w3.org/2000/svg" class="w-10 h-10 text-green-300" viewBox="0 0 24 24" fill="none" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M4.5 12a7.5 7.5 0 0 0 15 0"/></svg>
            <div>
                <h1 class="text-2xl font-bold">Kanban PCM</h1>
                <p class="text-sm text-gray-200 font-light">Cervejaria Heineken</p>
            </div>
        </div>
        <div class="flex items-center space-x-3">
            <button id="filter-priority-btn" class="relative hidden md:flex items-center space-x-2 bg-green-700 hover:bg-green-600 px-4 py-2 rounded-lg">
                <span class="text-sm font-medium">Prioridade</span>
            </button>

            <!-- seletor de prioridade ao lado do botão Adicionar -->
            <div class="flex items-center space-x-2 mr-2">
                <label for="header-priority-select" class="hidden md:block text-sm text-green-100">Prioridade</label>
                <select id="header-priority-select" class="px-3 py-2 rounded-lg bg-white text-sm border border-green-600">
                    <option value="low">Baixa</option>
                    <option value="medium" selected>Média</option>
                    <option value="high">Alta</option>
                </select>
            </div>

            <button id="add-task-btn" class="bg-green-600 hover:bg-green-700 px-5 py-2 rounded-lg font-semibold">Adicionar OS</button>
            <button id="logout-btn" class="bg-white text-green-700 px-3 py-2 rounded-lg border border-green-600 text-sm font-medium">Sair</button>
        </div>
    </div>
</header>

<div id="auth-status" class="py-2 px-6 bg-green-900 text-green-200 text-sm text-center sticky top-[80px] z-30">Conectando...</div>

<main id="kanban-board" class="grid grid-cols-1 md:grid-cols-3 lg:grid-cols-5 gap-6 p-6">
    <div class="kanban-column bg-white rounded-xl shadow-lg flex flex-col">
        <div class="p-4 border-b border-gray-200 flex justify-between items-center sticky top-[124px] bg-white rounded-t-xl z-10">
            <div class="flex items-center space-x-3">
                <span class="w-3 h-3 bg-red-500 rounded-full"></span>
                <h3 class="font-semibold text-gray-800 uppercase text-sm">Solicitações / Backlog</h3>
            </div>
            <span id="count-col-restaurar" class="px-2.5 py-0.5 bg-gray-200 text-gray-700 rounded-full font-semibold text-xs">0</span>
        </div>
        <div id="col-restaurar" class="p-4 space-y-4 kanban-column-body flex-grow min-h-[200px]" data-column-id="col-restaurar"></div>
    </div>

    <div class="kanban-column bg-white rounded-xl shadow-lg flex flex-col">
        <div class="p-4 border-b border-gray-200 flex justify-between items-center sticky top-[124px] bg-white rounded-t-xl z-10">
            <div class="flex items-center space-x-3">
                <span class="w-3 h-3 bg-yellow-500 rounded-full"></span>
                <h3 class="font-semibold text-gray-800 uppercase text-sm">Planejamento / Aguard. Peças</h3>
            </div>
            <span id="count-col-diagnostico" class="px-2.5 py-0.5 bg-gray-200 text-gray-700 rounded-full font-semibold text-xs">0</span>
        </div>
        <div id="col-diagnostico" class="p-4 space-y-4 kanban-column-body flex-grow min-h-[200px]" data-column-id="col-diagnostico"></div>
    </div>

    <div class="kanban-column bg-white rounded-xl shadow-lg flex flex-col">
        <div class="p-4 border-b border-gray-200 flex justify-between items-center sticky top-[124px] bg-white rounded-t-xl z-10">
            <div class="flex items-center space-x-3">
                <span class="w-3 h-3 bg-orange-500 rounded-full"></span>
                <h3 class="font-semibold text-gray-800 uppercase text-sm">Programado</h3>
            </div>
            <span id="count-col-restauracao" class="px-2.5 py-0.5 bg-gray-200 text-gray-700 rounded-full font-semibold text-xs">0</span>
        </div>
        <div id="col-restauracao" class="p-4 space-y-4 kanban-column-body flex-grow min-h-[200px]" data-column-id="col-restauracao"></div>
    </div>

    <div class="kanban-column bg-white rounded-xl shadow-lg flex flex-col">
        <div class="p-4 border-b border-gray-200 flex justify-between items-center sticky top-[124px] bg-white rounded-t-xl z-10">
            <div class="flex items-center space-x-3">
                <span class="w-3 h-3 bg-blue-500 rounded-full"></span>
                <h3 class="font-semibold text-gray-800 uppercase text-sm">Em Execução</h3>
            </div>
            <span id="count-col-teste" class="px-2.5 py-0.5 bg-gray-200 text-gray-700 rounded-full font-semibold text-xs">0</span>
        </div>
        <div id="col-teste" class="p-4 space-y-4 kanban-column-body flex-grow min-h-[200px]" data-column-id="col-teste"></div>
    </div>

    <div class="kanban-column bg-white rounded-xl shadow-lg flex flex-col">
        <div class="p-4 border-b border-gray-200 flex justify-between items-center sticky top-[124px] bg-white rounded-t-xl z-10">
            <div class="flex items-center space-x-3">
                <span class="w-3 h-3 bg-green-500 rounded-full"></span>
                <h3 class="font-semibold text-gray-800 uppercase text-sm">Concluído / Verificação</h3>
            </div>
            <span id="count-col-pronto" class="px-2.5 py-0.5 bg-gray-200 text-gray-700 rounded-full font-semibold text-xs">0</span>
        </div>
        <div id="col-pronto" class="p-4 space-y-4 kanban-column-body flex-grow min-h-[200px]" data-column-id="col-pronto"></div>
    </div>
</main>

<!-- Modais -->
<div id="task-modal" class="fixed inset-0 bg-black bg-opacity-60 flex items-center justify-center z-50 p-4 hidden">
    <div class="bg-white rounded-lg shadow-2xl max-w-lg w-full transform scale-95 opacity-0" id="task-modal-content">
        <form id="task-form">
            <div class="flex justify-between items-center p-5 border-b border-gray-200">
                <h4 id="modal-title" class="text-2xl font-semibold text-gray-800">Adicionar Ordem de Serviço</h4>
                <button type="button" id="close-modal-btn" class="text-gray-400 hover:text-gray-600">✕</button>
            </div>
            <div class="p-6 space-y-5">
                <div>
                    <label for="task-id-input" class="block text-sm font-medium text-gray-700 mb-1">Nº da OS / SM (Obrigatório)</label>
                    <input type="text" id="task-id-input" placeholder="Ex: OS-45102" class="w-full px-4 py-2 border border-gray-300 rounded-lg">
                    <p id="task-id-display" class="text-lg font-medium text-gray-600 hidden"></p>
                </div>
                <div>
                    <label for="task-text-input" class="block text-sm font-medium text-gray-700 mb-1">Descrição do Serviço <span class="text-red-500">*</span></label>
                    <textarea id="task-text-input" rows="4" placeholder="Descreva o serviço..." class="w-full px-4 py-2 border border-gray-300 rounded-lg" required></textarea>
                </div>
                <div>
                    <label for="task-priority-input" class="block text-sm font-medium text-gray-700 mb-1">Prioridade</label>
                    <select id="task-priority-input" class="w-full px-4 py-2 border border-gray-300 rounded-lg bg-white">
                        <option value="low">Baixa</option>
                        <option value="medium" selected>Média</option>
                        <option value="high">Alta</option>
                    </select>
                </div>
                <input type="hidden" id="task-id-hidden">
                <p id="modal-error-message" class="text-red-500 text-sm"></p>
            </div>
            <div class="flex justify-end items-center space-x-4 p-5 bg-gray-50 rounded-b-lg">
                <button type="button" id="cancel-modal-btn" class="px-5 py-2 rounded-lg bg-gray-200">Cancelar</button>
                <button type="submit" id="save-task-btn" class="px-6 py-2 rounded-lg bg-green-600 text-white">Salvar Ordem</button>
            </div>
        </form>
    </div>
</div>

<!-- delete modal -->
<div id="delete-modal" class="fixed inset-0 bg-black bg-opacity-60 flex items-center justify-center z-50 p-4 hidden">
    <div class="bg-white p-6 rounded-lg shadow-2xl max-w-sm w-full transform scale-95 opacity-0" id="delete-modal-content">
        <h4 class="text-xl font-semibold mb-4">Confirmar Encerramento</h4>
        <p class="text-gray-600 mb-6">Tem certeza de que deseja encerrar esta OS?</p>
        <div class="flex justify-end space-x-3">
            <button id="cancel-delete-btn" class="px-5 py-2 rounded-lg bg-gray-300">Cancelar</button>
            <button id="confirm-delete-btn" class="px-5 py-2 rounded-lg bg-red-600 text-white">Encerrar OS</button>
        </div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', () => {
    const SESSION_KEY = 'kanban_user_v1';
    const TASKS_PREFIX = 'kanban_tasks_v1::';

    const authStatus = document.getElementById('auth-status');
    const logoutBtn = document.getElementById('logout-btn');
    const addTaskBtn = document.getElementById('add-task-btn');
    const headerPrioritySelect = document.getElementById('header-priority-select');

    const columns = {
        "col-restaurar": document.getElementById('col-restaurar'),
        "col-diagnostico": document.getElementById('col-diagnostico'),
        "col-restauracao": document.getElementById('col-restauracao'),
        "col-teste": document.getElementById('col-teste'),
        "col-pronto": document.getElementById('col-pronto')
    };
    const columnIds = Object.keys(columns);

    // modal elems
    const taskModal = document.getElementById('task-modal');
    const taskModalContent = document.getElementById('task-modal-content');
    const taskForm = document.getElementById('task-form');
    const modalTitle = document.getElementById('modal-title');
    const closeModalBtn = document.getElementById('close-modal-btn');
    const cancelModalBtn = document.getElementById('cancel-modal-btn');
    const taskIdInput = document.getElementById('task-id-input');
    const taskIdDisplay = document.getElementById('task-id-display');
    const taskTextInput = document.getElementById('task-text-input');
    const taskPriorityInput = document.getElementById('task-priority-input');
    const taskIdHidden = document.getElementById('task-id-hidden');
    const modalErrorMessage = document.getElementById('modal-error-message');
    const deleteModal = document.getElementById('delete-modal');
    const deleteModalContent = document.getElementById('delete-modal-content');
    const cancelDeleteBtn = document.getElementById('cancel-delete-btn');
    const confirmDeleteBtn = document.getElementById('confirm-delete-btn');

    let state = { tasks: {} };
    let taskToDeleteId = null;
    let activePriorityFilter = 'all';

    // session
    const user = localStorage.getItem(SESSION_KEY);
    if (!user) location.replace('/login.html');
    authStatus.textContent = `Conectado como ${user.split('@')[0]}`;

    logoutBtn.addEventListener('click', () => {
        if (confirm('Deseja sair?')) {
            localStorage.removeItem(SESSION_KEY);
            location.href = '/login.html';
        }
    });

    function tasksKey() { return TASKS_PREFIX + encodeURIComponent(user); }
    function loadTasks() { try { return JSON.parse(localStorage.getItem(tasksKey())||'{}'); } catch { return {}; } }
    function saveTasks(obj){ localStorage.setItem(tasksKey(), JSON.stringify(obj)); }

    function showModal(modal, content){ modal.classList.remove('hidden'); setTimeout(()=>{ modal.classList.add('opacity-100'); content.classList.add('scale-100','opacity-100'); content.classList.remove('scale-95','opacity-0'); },10); }
    function hideModal(modal, content){ content.classList.remove('scale-100','opacity-100'); content.classList.add('scale-95','opacity-0'); modal.classList.remove('opacity-100'); setTimeout(()=> modal.classList.add('hidden'),200); }

    function openTaskModal(mode='add', taskId=null){
        modalErrorMessage.textContent = '';
        taskForm.reset();
        // preenche prioridade a partir do seletor do header (fallback 'medium')
        taskPriorityInput.value = (headerPrioritySelect && headerPrioritySelect.value) ? headerPrioritySelect.value : 'medium';

        if (mode === 'add') {
            modalTitle.textContent = 'Adicionar Nova Ordem de Serviço';
            taskIdHidden.value = '';
            taskIdInput.value = `OS-${Math.floor(10000 + Math.random() * 90000)}`;
            taskIdInput.classList.remove('hidden');
            taskIdDisplay.classList.add('hidden');
        } else if (mode === 'edit' && taskId) {
            const t = state.tasks[taskId];
            if (!t) return;
            modalTitle.textContent = 'Editar Ordem de Serviço';
            taskIdHidden.value = t.id;
            taskIdInput.classList.add('hidden');
            taskIdDisplay.textContent = `OS: ${t.id}`;
            taskIdDisplay.classList.remove('hidden');
            taskTextInput.value = t.text || '';
            taskPriorityInput.value = t.priority || 'medium';
        }
        showModal(taskModal, taskModalContent);
        setTimeout(()=> taskTextInput.focus(), 150);
    }
    function closeTaskModal(){ hideModal(taskModal, taskModalContent); }
    function showDeleteModal(id){ taskToDeleteId = id; showModal(deleteModal, deleteModalContent); }
    function hideDeleteModal(){ hideModal(deleteModal, deleteModalContent); taskToDeleteId = null; }

    function getPriorityClasses(priority){
        if (priority === 'high') return { border:'border-red-500', text:'Alta', bg:'bg-red-500' };
        if (priority === 'medium') return { border:'border-orange-500', text:'Média', bg:'bg-orange-500' };
        return { border:'border-blue-500', text:'Baixa', bg:'bg-blue-500' };
    }

    function createTaskElement(task){
        const p = getPriorityClasses(task.priority);
        const idSan = DOMPurify.sanitize(task.id);
        const textSan = DOMPurify.sanitize(task.text);
        const card = document.createElement('div');
        card.className = `task-card bg-white p-4 rounded-lg shadow-md border-l-4 ${p.border} cursor-move group relative`;
        card.dataset.taskId = task.id;
        card.innerHTML = `
            <p class="text-sm font-semibold text-gray-500">${idSan}</p>
            <p class="text-gray-800 mt-1.5 font-medium">${textSan}</p>
            <div class="flex justify-between items-center mt-3 pt-3 border-t border-gray-100">
                <span class="text-xs font-semibold px-2 py-0.5 rounded-full ${p.bg} text-white">${p.text}</span>
            </div>
            <button class="delete-task-btn absolute top-2 right-2 text-gray-400 hover:text-red-600 opacity-0 group-hover:opacity-100 transition-opacity" aria-label="Encerrar OS">✕</button>
        `;
        card.addEventListener('click', () => openTaskModal('edit', task.id));
        card.querySelector('.delete-task-btn').addEventListener('click', (e)=>{ e.stopPropagation(); showDeleteModal(task.id); });
        return card;
    }

    function renderBoard(){
        columnIds.forEach(id => columns[id].innerHTML = '');
        state.tasks = loadTasks();
        const counts = { "col-restaurar":0, "col-diagnostico":0, "col-restauracao":0, "col-teste":0, "col-pronto":0 };
        Object.values(state.tasks).forEach(t => {
            if (activePriorityFilter !== 'all' && t.priority !== activePriorityFilter) return;
            const col = t.column || 'col-restaurar';
            if (columns[col]) {
                columns[col].appendChild(createTaskElement(t));
                counts[col] = (counts[col]||0) + 1;
            }
        });
        document.getElementById('count-col-restaurar').textContent = counts['col-restaurar'];
        document.getElementById('count-col-diagnostico').textContent = counts['col-diagnostico'];
        document.getElementById('count-col-restauracao').textContent = counts['col-restauracao'];
        document.getElementById('count-col-teste').textContent = counts['col-teste'];
        document.getElementById('count-col-pronto').textContent = counts['col-pronto'];
    }

    // salvar via modal
    taskForm.addEventListener('submit', (e) => {
        e.preventDefault();
        modalErrorMessage.textContent = '';
        const text = taskTextInput.value.trim();
        const priority = taskPriorityInput.value;
        const editingId = taskIdHidden.value;
        if (!text) { modalErrorMessage.textContent = 'A descrição é obrigatória.'; return; }
        const all = loadTasks();
        if (editingId) {
            if (!all[editingId]) { modalErrorMessage.textContent = 'Tarefa não encontrada.'; return; }
            all[editingId].text = text;
            all[editingId].priority = priority;
            saveTasks(all);
            closeTaskModal();
            renderBoard();
            return;
        }
        const id = taskIdInput.value.trim();
        if (!id) { modalErrorMessage.textContent = 'Nº da OS/SM é obrigatório.'; return; }
        if (all[id]) { modalErrorMessage.textContent = 'Este número de OS/SM já existe.'; return; }
        all[id] = { id, text, priority, column: 'col-restaurar' };
        saveTasks(all);
        closeTaskModal();
        renderBoard();
    });

    confirmDeleteBtn.addEventListener('click', () => {
        if (taskToDeleteId) {
            const all = loadTasks();
            delete all[taskToDeleteId];
            saveTasks(all);
            renderBoard();
        }
        hideDeleteModal();
    });
    cancelDeleteBtn.addEventListener('click', hideDeleteModal);

    closeModalBtn.addEventListener('click', closeTaskModal);
    cancelModalBtn.addEventListener('click', closeTaskModal);
    taskModal.addEventListener('click', (e) => { if (e.target === taskModal) closeTaskModal(); });
    deleteModal.addEventListener('click', (e) => { if (e.target === deleteModal) hideDeleteModal(); });

    addTaskBtn.addEventListener('click', () => openTaskModal('add'));

    // drag & drop
    function initSortable(){
        columnIds.forEach(colId => {
            new Sortable(columns[colId], {
                group: 'kanban',
                animation: 150,
                ghostClass: 'sortable-ghost',
                chosenClass: 'sortable-chosen',
                onEnd: (evt) => {
                    const taskId = evt.item.dataset.taskId;
                    const newCol = evt.to.dataset.columnId;
                    const all = loadTasks();
                    if (all[taskId] && all[taskId].column !== newCol) {
                        all[taskId].column = newCol;
                        saveTasks(all);
                        renderBoard();
                    }
                }
            });
        });
    }

    initSortable();
    renderBoard();
});
</script>
</body>
</html>